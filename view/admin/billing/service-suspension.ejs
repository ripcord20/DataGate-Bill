<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Suspension - Admin Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.0.7/css/boxicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
        }
        
        .suspension-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .stats-card {
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .btn-suspend {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            border: none;
            border-radius: 8px;
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-restore {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border: none;
            border-radius: 8px;
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-check {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: white;
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <%- include('../../partials/billing-sidebar') %>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="bx bx-pause-circle"></i> Service Suspension
                    </h1>
                </div>

                <!-- Service Suspension Overview -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="suspension-card p-4">
                            <h4><i class="bx bx-shield-x me-2"></i>Kelola Service Suspension</h4>
                            <p class="mb-0">Sistem otomatis untuk menonaktifkan layanan pelanggan yang telat bayar menggunakan profile isolir Mikrotik dan mengaktifkan kembali setelah pembayaran.</p>
                        </div>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <i class="bx bx-user-check text-primary" style="font-size: 2rem;"></i>
                                <h3 class="text-primary" id="activeCustomers">-</h3>
                                <p class="text-muted mb-0">Pelanggan Aktif</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <i class="bx bx-pause-circle text-danger" style="font-size: 2rem;"></i>
                                <h3 class="text-danger" id="suspendedCustomers">-</h3>
                                <p class="text-muted mb-0">Pelanggan Suspended</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <i class="bx bx-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
                                <h3 class="text-warning" id="overdueInvoices">-</h3>
                                <p class="text-muted mb-0">Tagihan Overdue</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <i class="bx bx-time text-info" style="font-size: 2rem;"></i>
                                <h3 class="text-info" id="gracePeriod">7</h3>
                                <p class="text-muted mb-0">Grace Period (Hari)</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Isolir Profile Setting -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <strong>Pilih Profile Isolir (Mikrotik)</strong>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary me-2" id="reloadIsolirProfilesBtn">
                                        <i class="bx bx-refresh me-1"></i>Reload
                                    </button>
                                    <button class="btn btn-sm btn-primary" id="saveIsolirProfileBtn">
                                        <i class="bx bx-save me-1"></i>Simpan
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <label for="isolirProfileSelect" class="form-label">Profile Isolir</label>
                                <select id="isolirProfileSelect" class="form-select">
                                    <option value="default">Loading...</option>
                                </select>
                                <small class="text-muted">Dipakai saat Suspend. Default: 'isolir'.</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="bx bx-search text-warning" style="font-size: 3rem;"></i>
                                <h5>Cek Pelanggan Overdue</h5>
                                <p class="text-muted">Periksa dan suspend pelanggan yang telat bayar</p>
                                <button class="btn btn-check w-100" id="checkOverdueBtn">
                                    <i class="bx bx-search me-2"></i>Cek & Suspend Overdue
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="bx bx-check-circle text-success" style="font-size: 3rem;"></i>
                                <h5>Restore Pelanggan Bayar</h5>
                                <p class="text-muted">Aktifkan kembali pelanggan yang sudah bayar</p>
                                <button class="btn btn-restore w-100" id="checkPaidBtn">
                                    <i class="bx bx-check me-2"></i>Cek & Restore Paid
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="bx bx-refresh text-primary" style="font-size: 3rem;"></i>
                                <h5>Refresh Statistics</h5>
                                <p class="text-muted">Perbarui statistik terbaru</p>
                                <button class="btn btn-check w-100" id="refreshStatsBtn">
                                    <i class="bx bx-refresh me-2"></i>Refresh Stats
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Suspended Customers Table -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bx bx-pause-circle me-2"></i>Pelanggan Suspended</h5>
                                <button class="btn btn-sm btn-outline-primary" id="refreshTableBtn">
                                    <i class="bx bx-refresh me-1"></i>Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="suspendedTable">
                                        <thead>
                                            <tr>
                                                <th>Username</th>
                                                <th>Nama</th>
                                                <th>Phone</th>
                                                <th>Paket</th>
                                                <th>Status</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="6" class="text-center">Loading...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
        // Toast function
        function showToast(type, title, message) {
            const toastId = 'toast-' + Date.now();
            const iconMap = {
                success: 'bx bx-check-circle',
                error: 'bx bx-x-circle',
                warning: 'bx bx-exclamation-triangle',
                info: 'bx bx-info-circle'
            };

            const toastHtml = `
                <div id="${toastId}" class="toast ${type}" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="5000">
                    <div class="toast-header">
                        <i class="${iconMap[type]} me-2"></i>
                        <strong class="me-auto">${title}</strong>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">${message}</div>
                </div>
            `;

            $('#toast-container').append(toastHtml);
            new bootstrap.Toast(document.getElementById(toastId)).show();

            setTimeout(() => {
                $(`#${toastId}`).remove();
            }, 6000);
        }

        // Load statistics
        function loadStats() {
            $.get('/admin/billing/api/stats', function(stats) {
                $('#activeCustomers').text(stats.active_customers || 0);
            }).fail(() => {
                $('#activeCustomers').text('Error');
            });

            $.get('/admin/billing/api/customers', function(customers) {
                const suspended = customers.filter(c => c.status === 'suspended').length;
                $('#suspendedCustomers').text(suspended);
            }).fail(() => {
                $('#suspendedCustomers').text('Error');
            });

            $.get('/admin/billing/api/overdue', function(overdue) {
                $('#overdueInvoices').text(overdue.length);
            }).fail(() => {
                $('#overdueInvoices').text('Error');
            });
        }

        // Load suspended customers table
        function loadSuspendedCustomers() {
            $.get('/admin/billing/api/customers', function(customers) {
                const suspended = customers.filter(c => c.status === 'suspended');
                const tbody = $('#suspendedTable tbody');
                tbody.empty();

                if (suspended.length === 0) {
                    tbody.append('<tr><td colspan="6" class="text-center text-muted">Tidak ada pelanggan yang suspended</td></tr>');
                    return;
                }

                suspended.forEach(customer => {
                    const row = `
                        <tr>
                            <td>${customer.username}</td>
                            <td>${customer.name}</td>
                            <td>${customer.phone || '-'}</td>
                            <td>${customer.package_name || '-'}</td>
                            <td><span class="badge bg-danger">Suspended</span></td>
                            <td>
                                <button class="btn btn-sm btn-restore" onclick="restoreCustomer('${customer.username}')">
                                    <i class="bx bx-check me-1"></i>Restore
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            }).fail(() => {
                $('#suspendedTable tbody').html('<tr><td colspan="6" class="text-center text-danger">Error loading data</td></tr>');
            });
        }

        // Check overdue customers
        $('#checkOverdueBtn').click(function() {
            const btn = $(this);
            btn.prop('disabled', true).html('<i class="bx bx-loader-alt bx-spin me-2"></i>Checking...');

            $.post('/admin/billing/service-suspension/check-overdue', function(response) {
                if (response.success) {
                    showToast('success', 'Check Overdue Complete', 
                        `Checked: ${response.checked}, Suspended: ${response.suspended}, Errors: ${response.errors}`);
                    loadStats();
                    loadSuspendedCustomers();
                } else {
                    showToast('error', 'Error', response.message);
                }
            }).fail(function(xhr) {
                const response = xhr.responseJSON || {};
                showToast('error', 'Error', response.message || 'Request failed');
            }).always(function() {
                btn.prop('disabled', false).html('<i class="bx bx-search me-2"></i>Cek & Suspend Overdue');
            });
        });

        // Check paid customers
        $('#checkPaidBtn').click(function() {
            const btn = $(this);
            btn.prop('disabled', true).html('<i class="bx bx-loader-alt bx-spin me-2"></i>Checking...');

            $.post('/admin/billing/service-suspension/check-paid', function(response) {
                if (response.success) {
                    showToast('success', 'Check Paid Complete', 
                        `Checked: ${response.checked}, Restored: ${response.restored}, Errors: ${response.errors}`);
                    loadStats();
                    loadSuspendedCustomers();
                } else {
                    showToast('error', 'Error', response.message);
                }
            }).fail(function(xhr) {
                const response = xhr.responseJSON || {};
                showToast('error', 'Error', response.message || 'Request failed');
            }).always(function() {
                btn.prop('disabled', false).html('<i class="bx bx-check me-2"></i>Cek & Restore Paid');
            });
        });

        // Refresh stats
        $('#refreshStatsBtn').click(function() {
            const btn = $(this);
            btn.prop('disabled', true).html('<i class="bx bx-loader-alt bx-spin me-2"></i>Loading...');
            
            loadStats();
            
            setTimeout(() => {
                btn.prop('disabled', false).html('<i class="bx bx-refresh me-2"></i>Refresh Stats');
                showToast('success', 'Refreshed', 'Statistics updated');
            }, 1000);
        });

        // Refresh table
        $('#refreshTableBtn').click(function() {
            loadSuspendedCustomers();
            showToast('info', 'Refreshed', 'Table updated');
        });

        // Restore customer
        function restoreCustomer(username) {
            if (!confirm(`Yakin ingin restore layanan untuk pelanggan ${username}?`)) return;

            const reason = prompt('Masukkan alasan buka isolir (opsional):', 'Manual restore');
            if (reason === null) return; // user canceled prompt

            $.post(`/admin/billing/service-suspension/restore/${username}`, { reason }, function(response) {
                if (response.success) {
                    const r = (response.reason || reason || '').trim();
                    const msg = r ? `Layanan ${username} diaktifkan. Alasan: ${r}` : `Layanan ${username} berhasil diaktifkan`;
                    showToast('success', 'Service Restored', msg);
                    loadStats();
                    loadSuspendedCustomers();
                } else {
                    showToast('error', 'Error', response.message);
                }
            }).fail(function(xhr) {
                const response = xhr.responseJSON || {};
                showToast('error', 'Error', response.message || 'Request failed');
            });
        }

        // Initialize
        $(document).ready(function() {
            // Load isolir profiles and current setting
            loadIsolirProfiles();
            loadCurrentIsolirProfile();
            loadStats();
            loadSuspendedCustomers();
        });

        // Load Mikrotik PPPoE profiles into isolir select
        function loadIsolirProfiles(selected) {
            const sel = document.getElementById('isolirProfileSelect');
            if (!sel) return;
            sel.innerHTML = '<option>Loading...</option>';
            fetch('/admin/mikrotik/profiles/api')
                .then(r => r.json())
                .then(data => {
                    const names = Array.from(new Set(((data && data.profiles) || []).map(p => p.name).filter(Boolean)));
                    if (!names.includes('isolir')) names.unshift('isolir');
                    sel.innerHTML = '';
                    names.forEach(n => {
                        const opt = document.createElement('option');
                        opt.value = n;
                        opt.textContent = n;
                        sel.appendChild(opt);
                    });
                    if (selected) sel.value = selected;
                })
                .catch(err => {
                    console.error('Load isolir profiles error:', err);
                    sel.innerHTML = '<option value="isolir">isolir</option>';
                    showToast('error', 'Gagal', 'Gagal memuat profile Mikrotik');
                });
        }

        // Get current isolir profile setting
        function loadCurrentIsolirProfile() {
            fetch('/admin/billing/service-suspension/isolir-profile')
                .then(r => r.json())
                .then(data => {
                    if (data && data.success) {
                        const current = data.isolir_profile || 'isolir';
                        // ensure options exist then set
                        const sel = document.getElementById('isolirProfileSelect');
                        if (sel && sel.options.length > 0) {
                            sel.value = current;
                            if (sel.value !== current) {
                                const opt = document.createElement('option');
                                opt.value = current;
                                opt.textContent = current;
                                sel.appendChild(opt);
                                sel.value = current;
                            }
                        } else {
                            loadIsolirProfiles(current);
                        }
                    }
                })
                .catch(() => {});
        }

        // Save isolir profile
        $('#saveIsolirProfileBtn').click(function(){
            const sel = document.getElementById('isolirProfileSelect');
            if (!sel) return;
            const value = sel.value || 'isolir';
            const btn = $(this);
            btn.prop('disabled', true).html('<i class="bx bx-loader-alt bx-spin me-1"></i>Menyimpan...');
            fetch('/admin/billing/service-suspension/isolir-profile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
                body: new URLSearchParams({ isolir_profile: value }).toString()
            }).then(r => r.json()).then(data => {
                if (data && data.success) {
                    showToast('success', 'Tersimpan', `Isolir profile diset ke: ${value}`);
                } else {
                    showToast('error', 'Gagal', data.message || 'Gagal menyimpan');
                }
            }).catch(err => {
                showToast('error', 'Gagal', 'Gagal menyimpan');
            }).finally(() => {
                btn.prop('disabled', false).html('<i class="bx bx-save me-1"></i>Simpan');
            });
        });

        // Reload profiles button
        $('#reloadIsolirProfilesBtn').click(function(){
            const current = document.getElementById('isolirProfileSelect')?.value;
            loadIsolirProfiles(current);
        });
    </script>
</body>
</html>
